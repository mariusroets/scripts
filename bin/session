#!/bin/bash

ALLOWED_TYPES=("dev" "ipp" "powi" "raw")
contains() {
    needle=$1
    for t in ${ALLOWED_TYPES[@]}; do
        if [[ $t == $needle ]]; then
            return 1
        fi
    done
    return 0
}
if [[ $# == 0 ]]; then
    echo "session [-s] [-l] [-t raw/dev] [-a <user>] [<session_name>]"
    echo "-s : Create a shared session. Only one allowed"
    echo "-l : List sessions. With -s, list shared sessions. -s must be first then"
    echo "-t : raw(default) or dev. raw only starts tmux. dev activates environments and starts nvim too."
    echo "-a : grants access to shared session for user. Run in session on its own"
    echo "<session_name> : The name of the session. Not necesasry if for -l and -a."
    exit 0
fi
OPTSTRING="slt:a:"
TM=tmux
DEV=false
RAW=true
TYPE="raw"
while getopts $OPTSTRING opt; do
    case $opt in
        s)
            TM="tmux -S /var/tmux/shared-session"
            ;;
        l)
            $TM ls
            exit 0
            ;;
        t)
            TYPE="$OPTARG"
            contains $TYPE
            x=$?
            if [[ $x != 1 ]]; then
                echo $TYPE must be one of ${ALLOWED_TYPES[@]}
                exit 0
            fi
            ;;
        a)
            chmod 777 /var/tmux/shared-session
            tmux server-access -a $OPTARG
            exit 0
            ;;
    esac
done
NAME=default
i=1
j=$#
while [[ $i -le $j ]]; do
    if [[ $i == $OPTIND ]]; then
        NAME=$1
        echo "name is $1"
    fi
    i=$((i+1));
    shift 1;
done
if [[ "$TYPE" == "dev" ]]; then
    if [[ "$NAME" =~ ^[./~] ]]; then
        DIR=$NAME
        $NAME=dev-default
    else
        DIR=/data/code/$NAME
    fi
    $TM new-session -A -s dev-$NAME -n $NAME -c $DIR -d
    if [[ -f $DIR/.venv ]]; then
        $TM send-keys -t $NAME "source .venv/bin/activate" C-m
    fi
    $TM send-keys -t $NAME "nvim" C-m
    $TM attach-session -t dev-$NAME
fi
if [[ "$TYPE" == "raw" ]]; then
    $TM new-session -A -s $NAME -n $NAME
fi
if [[ "$TYPE" == "ipp" ]]; then
    NAME=ipp
    $TM new-session -A -s $NAME -n $NAME -d \; \
        split-window -h \; split-window -h \; \
        select-layout even-horizontal\; \
        select-pane -t 1 \; split-window -v \; \
        select-pane -t 3 \; split-window -v \; \
        select-pane -t 5 \; split-window -v \; \
        set-window-option synchronize-panes on \; \
        send-keys "ssh roetsm@powi" C-m \; set-window-option synchronize-panes off \; \
        select-pane -t 1 \; send-keys "ssh roetsm@mp2vlsa404" C-m\; \
        select-pane -t 2 \; send-keys "ssh roetsm@mp2vlsa404" C-m\; \
        select-pane -t 3 \; send-keys "ssh roetsm@mp2vlsa441" C-m\; \
        select-pane -t 4 \; send-keys "ssh roetsm@mp2vlsa441" C-m\; \
        select-pane -t 5 \; send-keys "ssh roetsm@mp2vlsa442" C-m\; \
        select-pane -t 6 \; send-keys "ssh roetsm@mp2vlsa442" C-m\; \
        select-pane -t 2 \; send-keys "ssh roetsm@mp2vlsa403" C-m\; \
        select-pane -t 4 \; send-keys "ssh roetsm@mp2vlsa443" C-m\; \
        select-pane -t 6 \; send-keys "ssh roetsm@mp2vlsa444" C-m\;

    $TM attach-session -t $NAME
fi
if [[ "$TYPE" == "powi" ]]; then
    NAME=powi
    $TM new-session -A -s $NAME -n $NAME -d \; \
        split-window -h \; split-window -v \; \
        select-pane -t 2 \; send-keys "ssh roetsm@powi" C-m \; send-keys "top" C-m\; \
        select-pane -t 3 \; send-keys "ssh roetsm@powi" C-m \; send-keys "df -h" C-m\; \
        select-pane -t 1 \; send-keys "ssh roetsm@powi" C-m \; send-keys "become web" C-m\; \
        resize-pane -R 5 \; send-keys "dockerps" C-m \;
    $TM attach-session -t $NAME
fi

# if [ "$1" == "detach" ]; then
#     tmux detach
#     exit 0
# elif [ "$1" == "list" ]; then
#     tmux list-sessions
#     exit 0
# elif [ "$1" == "kill" ]; then
#     tmux kill-session
#     exit 0
# fi
#
# if [ $# -ge 1 ]; then
#     SESSION_NAME=$1
#     if [ $# -eq 2 ]; then
#         RUN_PATH="$2"
#     else
#         RUN_PATH=/data/python/pythonmodules
#     fi
# else
#     SESSION_NAME=default
# fi
#
# tmux has-session -t $SESSION_NAME &> /dev/null
# if [ $? != 0 ]; then
#     if [ "$SESSION_NAME" == "prog" ]; then
#         tmux new-session -s $SESSION_NAME -n python -c $RUN_PATH -d
#         tmux send-keys -t $SESSION_NAME:python "conda activate development" C-m
#         tmux send-keys -t $SESSION_NAME:python "gvim" C-m
#     elif [ "$SESSION_NAME" == "web" ]; then
#         tmux new-session -s $SESSION_NAME -c /data/python/dpowi -n web -d
#         tmux send-keys -t $SESSION_NAME:web "conda activate powi" C-m
#         tmux send-keys -t $SESSION_NAME:web "gvim" C-m
#         tmux send-keys -t $SESSION_NAME:web "alias run='./manage.py runserver_plus'" C-m
#     elif [ "$SESSION_NAME" == "jupyter" ]; then
#         tmux new-session -s $SESSION_NAME -c /data/python/projects -n jupyter -d
#         tmux send-keys -t $SESSION_NAME:jupyter "conda activate analysis" C-m
#         tmux send-keys -t $SESSION_NAME:jupyter "jupyter lab" C-m
#     else
#         tmux new-session -s $SESSION_NAME -n home -d
#         if [ "$SESSION_NAME" == "ipython" ]; then
#             tmux send-keys -t $SESSION_NAME:home "conda activate analysis" C-m
#             tmux send-keys -t $SESSION_NAME:home "ipython" C-m
#         fi
#         if [ -n "$TMUX" ]; then
#             echo "Session $SESSION_NAME created, but not attached. Detach from this one first"
#             exit 1
#         fi
#     fi
# else
#     if [ -n "$TMUX" ]; then
#         CURRENT_SESSION=`tmux display-message -p '#S'`
#         echo "You are attached to session $CURRENT_SESSION. Detach first."
#         exit 1
#     fi
# fi
# tmux attach-session -t $SESSION_NAME
